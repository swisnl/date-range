<?php

use Swis\DateRange\DateRange;

it('refuses to create backwards range', function () {
    DateRange::make(
        createDate('2021-01-31'),
        createDate('2021-01-01')
    );
})->throws(InvalidArgumentException::class, 'End date must be after start date');

it('is immutable', function () {
    $dateRange = DateRange::make(
        createDate('2021-01-01'),
        createDate('2021-01-31')
    );

    $newDateRange = $dateRange->setStartDate(createDate('2020-01-01'));
    expect($dateRange->getStartDate())->not->toBe($newDateRange->getStartDate());

    $newDateRange = $dateRange->setEndDate(createDate('2021-02-01'));
    expect($dateRange->getEndDate())->not->toBe($newDateRange->getEndDate());
});

it('creates range from array', function () {
    $dateRange = DateRange::fromArray(['2021-01-01', '2021-01-31']);

    expect($dateRange->getStartDate()?->toDateString())->toEqual('2021-01-01')
        ->and($dateRange->getEndDate()?->toDateString())->toEqual('2021-01-31');
});

it('converts to array', function () {
    $dateRange = DateRange::make(
        createDate('2021-01-01'),
        createDate('2021-01-31')
    );

    expect($dateRange->toArray())->toEqual(['2021-01-01', '2021-01-31']);
});

it('clones', function () {
    $dateRange = DateRange::make(
        createDate('2021-01-01'),
        createDate('2021-01-31')
    );

    $clonedDateRange = $dateRange->clone();
    expect($dateRange->toArray())->toEqual($clonedDateRange->toArray())
        ->and($dateRange)->not->toBe($clonedDateRange)
        ->and($dateRange->getStartDate())->not->toBe($clonedDateRange->getStartDate())
        ->and($dateRange->getEndDate())->not->toBe($clonedDateRange->getEndDate());
});

it('determines if a date is in range', function (array $range, array $assertions) {
    $dateRange = DateRange::fromArray($range);

    foreach ($assertions as [$date, $expected]) {
        expect($dateRange->inRange(createDate($date)))->toMatchConstraint(constraintFromBoolean($expected));
    }
})->with([
    'start end' => [
        ['2021-01-01', '2021-01-31'],
        [
            ['2020-12-31', false],
            ['2021-01-01', true],
            ['2021-01-10', true],
            ['2021-01-31', true],
            ['2021-02-01', false],
        ],
    ],
    'start' => [
        ['2021-01-01', null],
        [
            ['2020-12-31', false],
            ['2021-01-01', true],
            ['2021-01-10', true],
            ['2021-01-31', true],
            ['2021-02-01', true],
        ],
    ],
    'end' => [
        [null, '2021-01-31'],
        [
            ['2020-12-31', true],
            ['2021-01-01', true],
            ['2021-01-10', true],
            ['2021-01-31', true],
            ['2021-02-01', false],
        ],
    ],
    'open' => [
        [null, null],
        [
            ['2020-12-31', true],
            ['2021-01-01', true],
            ['2021-01-10', true],
            ['2021-01-31', true],
            ['2021-02-01', true],
        ],
    ],
]);

dataset('intersect', [
    'start end' => [
        ['2021-01-01', '2021-01-31'],
        [
            [['2020-12-01', '2020-12-31'], null],
            [['2021-01-15', '2021-01-20'], ['2021-01-15', '2021-01-20']],
            [['2021-01-01', '2021-01-15'], ['2021-01-01', '2021-01-15']],
            [['2021-01-01', '2021-01-31'], ['2021-01-01', '2021-01-31']],
            [['2021-01-20', '2021-01-31'], ['2021-01-20', '2021-01-31']],
            [['2021-02-01', '2021-02-28'], null],
            [['2020-12-01', '2021-01-15'], ['2021-01-01', '2021-01-15']],
            [['2021-01-15', '2021-02-28'], ['2021-01-15', '2021-01-31']],
            [['2020-12-01', '2021-02-28'], ['2021-01-01', '2021-01-31']],
            [['2020-12-01', null],         ['2021-01-01', '2021-01-31']],
            [['2021-01-01', null],         ['2021-01-01', '2021-01-31']],
            [['2021-01-15', null],         ['2021-01-15', '2021-01-31']],
            [['2021-01-20', null],         ['2021-01-20', '2021-01-31']],
            [['2021-02-01', null],         null],
            [[null,         '2020-12-31'], null],
            [[null,         '2021-01-15'], ['2021-01-01', '2021-01-15']],
            [[null,         '2021-01-20'], ['2021-01-01', '2021-01-20']],
            [[null,         '2021-01-31'], ['2021-01-01', '2021-01-31']],
            [[null,         '2021-02-28'], ['2021-01-01', '2021-01-31']],
            [[null,         null],         ['2021-01-01', '2021-01-31']],
        ],
    ],
    'start' => [
        ['2021-01-01', null],
        [
            [['2020-12-01', '2020-12-31'], null],
            [['2021-01-15', '2021-01-20'], ['2021-01-15', '2021-01-20']],
            [['2021-01-01', '2021-01-15'], ['2021-01-01', '2021-01-15']],
            [['2021-01-01', '2021-01-31'], ['2021-01-01', '2021-01-31']],
            [['2021-01-20', '2021-01-31'], ['2021-01-20', '2021-01-31']],
            [['2021-02-01', '2021-02-28'], ['2021-02-01', '2021-02-28']],
            [['2020-12-01', '2021-01-15'], ['2021-01-01', '2021-01-15']],
            [['2021-01-15', '2021-02-28'], ['2021-01-15', '2021-02-28']],
            [['2020-12-01', '2021-02-28'], ['2021-01-01', '2021-02-28']],
            [['2020-12-01', null],         ['2021-01-01', null]],
            [['2021-01-01', null],         ['2021-01-01', null]],
            [['2021-01-15', null],         ['2021-01-15', null]],
            [['2021-01-20', null],         ['2021-01-20', null]],
            [['2021-02-01', null],         ['2021-02-01', null]],
            [[null,         '2020-12-31'], null],
            [[null,         '2021-01-15'], ['2021-01-01', '2021-01-15']],
            [[null,         '2021-01-20'], ['2021-01-01', '2021-01-20']],
            [[null,         '2021-01-31'], ['2021-01-01', '2021-01-31']],
            [[null,         '2021-02-28'], ['2021-01-01', '2021-02-28']],
            [[null,         null],         ['2021-01-01', null]],
        ],
    ],
    'end' => [
        [null, '2021-01-31'],
        [
            [['2020-12-01', '2020-12-31'], ['2020-12-01', '2020-12-31']],
            [['2021-01-15', '2021-01-20'], ['2021-01-15', '2021-01-20']],
            [['2021-01-01', '2021-01-15'], ['2021-01-01', '2021-01-15']],
            [['2021-01-01', '2021-01-31'], ['2021-01-01', '2021-01-31']],
            [['2021-01-20', '2021-01-31'], ['2021-01-20', '2021-01-31']],
            [['2021-02-01', '2021-02-28'], null],
            [['2020-12-01', '2021-01-15'], ['2020-12-01', '2021-01-15']],
            [['2021-01-15', '2021-02-28'], ['2021-01-15', '2021-01-31']],
            [['2020-12-01', '2021-02-28'], ['2020-12-01', '2021-01-31']],
            [['2020-12-01', null],         ['2020-12-01', '2021-01-31']],
            [['2021-01-01', null],         ['2021-01-01', '2021-01-31']],
            [['2021-01-15', null],         ['2021-01-15', '2021-01-31']],
            [['2021-01-20', null],         ['2021-01-20', '2021-01-31']],
            [['2021-02-01', null],         null],
            [[null,         '2020-12-31'], [null,         '2020-12-31']],
            [[null,         '2021-01-15'], [null,         '2021-01-15']],
            [[null,         '2021-01-20'], [null,         '2021-01-20']],
            [[null,         '2021-01-31'], [null,         '2021-01-31']],
            [[null,         '2021-02-28'], [null,         '2021-01-31']],
            [[null,         null],         [null,         '2021-01-31']],
        ],
    ],
    'open' => [
        [null, null],
        [
            [['2020-12-01', '2020-12-31'], ['2020-12-01', '2020-12-31']],
            [['2021-01-15', '2021-01-20'], ['2021-01-15', '2021-01-20']],
            [['2021-01-01', '2021-01-15'], ['2021-01-01', '2021-01-15']],
            [['2021-01-01', '2021-01-31'], ['2021-01-01', '2021-01-31']],
            [['2021-01-20', '2021-01-31'], ['2021-01-20', '2021-01-31']],
            [['2021-02-01', '2021-02-28'], ['2021-02-01', '2021-02-28']],
            [['2020-12-01', '2021-01-15'], ['2020-12-01', '2021-01-15']],
            [['2021-01-15', '2021-02-28'], ['2021-01-15', '2021-02-28']],
            [['2020-12-01', '2021-02-28'], ['2020-12-01', '2021-02-28']],
            [['2020-12-01', null],         ['2020-12-01', null]],
            [['2021-01-01', null],         ['2021-01-01', null]],
            [['2021-01-15', null],         ['2021-01-15', null]],
            [['2021-01-20', null],         ['2021-01-20', null]],
            [['2021-02-01', null],         ['2021-02-01', null]],
            [[null,         '2020-12-31'], [null,         '2020-12-31']],
            [[null,         '2021-01-15'], [null,         '2021-01-15']],
            [[null,         '2021-01-20'], [null,         '2021-01-20']],
            [[null,         '2021-01-31'], [null,         '2021-01-31']],
            [[null,         '2021-02-28'], [null,         '2021-02-28']],
            [[null,         null],         [null,         null]],
        ],
    ],
]);

it('determines overlap', function (array $range, array $assertions) {
    $dateRange = DateRange::fromArray($range);

    foreach ($assertions as [$otherRange, $expectedIntersection]) {
        $otherDateRange = DateRange::fromArray($otherRange);
        $expected = $expectedIntersection !== null;

        expect($dateRange->overlaps($otherDateRange))->toMatchConstraint(constraintFromBoolean($expected))
            ->and($otherDateRange->overlaps($dateRange))->toMatchConstraint(constraintFromBoolean($expected));
    }
})->with('intersect');

it('determines intersection', function (array $range, array $assertions) {
    $dateRange = DateRange::fromArray($range);

    $dateRange = DateRange::fromArray($range);

    foreach ($assertions as [$otherRange, $expected]) {
        $otherDateRange = DateRange::fromArray($otherRange);

        $intersect = $dateRange->intersect($otherDateRange);
        if ($expected === null) {
            expect($intersect)->toBeNull();
        } else {
            expect($intersect)->not->toBeNull()
                ->and($intersect?->toArray())->toEqual($expected);
        }

        $intersect = $otherDateRange->intersect($dateRange);
        if ($expected === null) {
            expect($intersect)->toBeNull();
        } else {
            expect($intersect)->not->toBeNull()
                ->and($intersect?->toArray())->toEqual($expected);
        }
    }
})->with('intersect');

it('subtracts ranges', function (array $range, array $assertions) {
    $dateRange = DateRange::fromArray($range);

    foreach ($assertions as [$otherRange, $expectedRanges]) {
        $otherDateRange = DateRange::fromArray($otherRange);

        $subtracted = $dateRange->subtract($otherDateRange);

        expect($subtracted->toArray())->toEqual($expectedRanges);
    }
})->with([
    'start end' => [
        ['2021-01-01', '2021-01-31'],
        [
            [['2020-12-01', '2020-12-31'], [['2021-01-01', '2021-01-31']]],
            [['2021-01-15', '2021-01-20'], [['2021-01-01', '2021-01-14'], ['2021-01-21', '2021-01-31']]],
            [['2021-01-01', '2021-01-15'], [['2021-01-16', '2021-01-31']]],
            [['2021-01-01', '2021-01-31'], []],
            [['2021-01-20', '2021-01-31'], [['2021-01-01', '2021-01-19']]],
            [['2021-02-01', '2021-02-28'], [['2021-01-01', '2021-01-31']]],
            [['2020-12-01', '2021-01-15'], [['2021-01-16', '2021-01-31']]],
            [['2021-01-15', '2021-02-28'], [['2021-01-01', '2021-01-14']]],
            [['2020-12-01', '2021-02-28'], []],
            [['2020-12-01', null],         []],
            [['2021-01-01', null],         []],
            [['2021-01-15', null],         [['2021-01-01', '2021-01-14']]],
            [['2021-01-20', null],         [['2021-01-01', '2021-01-19']]],
            [['2021-02-01', null],         [['2021-01-01', '2021-01-31']]],
            [[null,         '2020-12-31'], [['2021-01-01', '2021-01-31']]],
            [[null,         '2021-01-15'], [['2021-01-16', '2021-01-31']]],
            [[null,         '2021-01-20'], [['2021-01-21', '2021-01-31']]],
            [[null,         '2021-01-31'], []],
            [[null,         '2021-02-28'], []],
            [[null,         null],         []],
        ],
    ],
    'start' => [
        ['2021-01-01', null],
        [
            [['2020-12-01', '2020-12-31'], [['2021-01-01', null]]],
            [['2021-01-15', '2021-01-20'], [['2021-01-01', '2021-01-14'], ['2021-01-21', null]]],
            [['2021-01-01', '2021-01-15'], [['2021-01-16', null]]],
            [['2021-01-01', '2021-01-31'], [['2021-02-01', null]]],
            [['2021-01-20', '2021-01-31'], [['2021-01-01', '2021-01-19'], ['2021-02-01', null]]],
            [['2021-02-01', '2021-02-28'], [['2021-01-01', '2021-01-31'], ['2021-03-01', null]]],
            [['2020-12-01', '2021-01-15'], [['2021-01-16', null]]],
            [['2021-01-15', '2021-02-28'], [['2021-01-01', '2021-01-14'], ['2021-03-01', null]]],
            [['2020-12-01', '2021-02-28'], [['2021-03-01', null]]],
            [['2020-12-01', null],         []],
            [['2021-01-01', null],         []],
            [['2021-01-15', null],         [['2021-01-01', '2021-01-14']]],
            [['2021-01-20', null],         [['2021-01-01', '2021-01-19']]],
            [['2021-02-01', null],         [['2021-01-01', '2021-01-31']]],
            [[null,         '2020-12-31'], [['2021-01-01', null]]],
            [[null,         '2021-01-15'], [['2021-01-16', null]]],
            [[null,         '2021-01-20'], [['2021-01-21', null]]],
            [[null,         '2021-01-31'], [['2021-02-01', null]]],
            [[null,         '2021-02-28'], [['2021-03-01', null]]],
            [[null,         null],         []],
        ],
    ],
    'end' => [
        [null, '2021-01-31'],
        [
            [['2020-12-01', '2020-12-31'], [[null, '2020-11-30'], ['2021-01-01', '2021-01-31']]],
            [['2021-01-15', '2021-01-20'], [[null, '2021-01-14'], ['2021-01-21', '2021-01-31']]],
            [['2021-01-01', '2021-01-15'], [[null, '2020-12-31'], ['2021-01-16', '2021-01-31']]],
            [['2021-01-01', '2021-01-31'], [[null, '2020-12-31']]],
            [['2021-01-20', '2021-01-31'], [[null, '2021-01-19']]],
            [['2021-02-01', '2021-02-28'], [[null, '2021-01-31']]],
            [['2020-12-01', '2021-01-15'], [[null, '2020-11-30'], ['2021-01-16', '2021-01-31']]],
            [['2021-01-15', '2021-02-28'], [[null, '2021-01-14']]],
            [['2020-12-01', '2021-02-28'], [[null, '2020-11-30']]],
            [['2020-12-01', null],         [[null, '2020-11-30']]],
            [['2021-01-01', null],         [[null, '2020-12-31']]],
            [['2021-01-15', null],         [[null, '2021-01-14']]],
            [['2021-01-20', null],         [[null, '2021-01-19']]],
            [['2021-02-01', null],         [[null, '2021-01-31']]],
            [[null,         '2020-12-31'], [['2021-01-01', '2021-01-31']]],
            [[null,         '2021-01-15'], [['2021-01-16', '2021-01-31']]],
            [[null,         '2021-01-20'], [['2021-01-21', '2021-01-31']]],
            [[null,         '2021-01-31'], []],
            [[null,         '2021-02-28'], []],
            [[null,         null],         []],
        ],
    ],
    'open' => [
        [null, null],
        [
            [['2020-12-01', '2020-12-31'], [[null, '2020-11-30'], ['2021-01-01', null]]],
            [['2021-01-15', '2021-01-20'], [[null, '2021-01-14'], ['2021-01-21', null]]],
            [['2021-01-01', '2021-01-15'], [[null, '2020-12-31'], ['2021-01-16', null]]],
            [['2021-01-01', '2021-01-31'], [[null, '2020-12-31'], ['2021-02-01', null]]],
            [['2021-01-20', '2021-01-31'], [[null, '2021-01-19'], ['2021-02-01', null]]],
            [['2021-02-01', '2021-02-28'], [[null, '2021-01-31'], ['2021-03-01', null]]],
            [['2020-12-01', '2021-01-15'], [[null, '2020-11-30'], ['2021-01-16', null]]],
            [['2021-01-15', '2021-02-28'], [[null, '2021-01-14'], ['2021-03-01', null]]],
            [['2020-12-01', '2021-02-28'], [[null, '2020-11-30'], ['2021-03-01', null]]],
            [['2020-12-01', null],         [[null, '2020-11-30']]],
            [['2021-01-01', null],         [[null, '2020-12-31']]],
            [['2021-01-15', null],         [[null, '2021-01-14']]],
            [['2021-01-20', null],         [[null, '2021-01-19']]],
            [['2021-02-01', null],         [[null, '2021-01-31']]],
            [[null,         '2020-12-31'], [['2021-01-01', null]]],
            [[null,         '2021-01-15'], [['2021-01-16', null]]],
            [[null,         '2021-01-20'], [['2021-01-21', null]]],
            [[null,         '2021-01-31'], [['2021-02-01', null]]],
            [[null,         '2021-02-28'], [['2021-03-01', null]]],
            [[null,         null],         []],
        ],
    ],
]);
